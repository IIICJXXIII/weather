{% extends 'base.html' %}
{% load static %}

{% block title %}æ•°æ®å¯¹æ¯” - NCDC æ°”è±¡æ•°æ®å¹³å°{% endblock %}

{% block extra_head %}
<style>
    /* é¡µé¢å±…ä¸­å¸ƒå±€ */
    .compare-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }
    .compare-row {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
    }
    .compare-content {
        width: 100%;
        max-width: 1000px;
    }
    .province-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px 0;
        justify-content: center;
    }
    .province-checkbox {
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .province-checkbox input {
        display: none;
    }
    .checkbox-label {
        padding: 8px 16px;
        background: rgba(0, 30, 60, 0.6);
        border: 1px solid rgba(0, 198, 251, 0.3);
        border-radius: 20px;
        color: #fff;
        font-size: 13px;
        transition: all 0.3s ease;
    }
    .province-checkbox input:checked + .checkbox-label {
        background: rgba(0, 198, 251, 0.3);
        border-color: #00C6FB;
        color: #00C6FB;
    }
    .checkbox-label:hover {
        border-color: #00C6FB;
    }
    .ml-2 {
        margin-left: 10px;
    }
    .btn-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="compare-container">
    <div class="page-header">
        <h1 class="page-title">âš–ï¸ å¤šçœä»½æ•°æ®å¯¹æ¯”</h1>
        <p class="page-subtitle">é€‰æ‹©å¤šä¸ªçœä»½è¿›è¡Œæ°”è±¡æ•°æ®å¯¹æ¯”åˆ†æ</p>
    </div>

    <!-- é€‰æ‹©è¡¨å• -->
    <div class="compare-row">
        <div class="compare-content">
            <div class="panel">
                <form method="get" id="compareForm">
                    <h4 class="panel-title">é€‰æ‹©å¯¹æ¯”çœä»½ï¼ˆæœ€å¤šé€‰æ‹©5ä¸ªï¼‰</h4>
                    <div class="province-selector">
                        {% for p in provinces %}
                        <label class="province-checkbox">
                            <input type="checkbox" name="provinces" value="{{ p }}" 
                                   {% if p in selected_provinces %}checked{% endif %}
                                   onchange="checkLimit(this)">
                            <span class="checkbox-label">{{ p }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="btn-group mt-3">
                        <button type="submit" class="btn-primary-custom">
                            ğŸ“Š å¼€å§‹å¯¹æ¯”
                        </button>
                        <button type="button" class="btn-secondary-custom" onclick="clearSelection()">
                            ğŸ—‘ï¸ æ¸…é™¤é€‰æ‹©
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å¯¹æ¯”ç»“æœ -->
    {% if compare_data %}
    <div class="compare-row">
        <div class="compare-content">
            <!-- æ¸©åº¦å¯¹æ¯”å›¾ -->
            <div class="panel mb-4">
                <h4 class="panel-title">ğŸŒ¡ï¸ å„çœä»½æœˆåº¦æ¸©åº¦å¯¹æ¯”</h4>
                <div class="chart-box" id="tempCompareChart"></div>
            </div>
            
            <!-- é£é€Ÿå¯¹æ¯”å›¾ -->
            <div class="panel">
                <h4 class="panel-title">ğŸ’¨ å„çœä»½æœˆåº¦é£é€Ÿå¯¹æ¯”</h4>
                <div class="chart-box" id="windCompareChart"></div>
            </div>
        </div>
    </div>
    {% elif selected_provinces %}
    <div class="compare-row">
        <div class="compare-content">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‰</div>
                <div class="empty-state-text">æœªæ‰¾åˆ°å¯¹æ¯”æ•°æ®</div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="compare-row">
        <div class="compare-content">
            <div class="empty-state">
                <div class="empty-state-icon">â˜ï¸</div>
                <div class="empty-state-text">è¯·é€‰æ‹©2-5ä¸ªçœä»½è¿›è¡Œå¯¹æ¯”åˆ†æ</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    var months = {{ months }};
    var compareData = {{ compare_data }};
    
    // é™åˆ¶æœ€å¤šé€‰æ‹©5ä¸ª
    function checkLimit(checkbox) {
        var checked = document.querySelectorAll('input[name="provinces"]:checked');
        if (checked.length > 5) {
            checkbox.checked = false;
            alert('æœ€å¤šåªèƒ½é€‰æ‹©5ä¸ªçœä»½è¿›è¡Œå¯¹æ¯”');
        }
    }
    
    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
        document.querySelectorAll('input[name="provinces"]').forEach(function(cb) {
            cb.checked = false;
        });
    }
    
    // æ¸²æŸ“å¯¹æ¯”å›¾è¡¨
    if (compareData && compareData.length > 0) {
        // é¢œè‰²åˆ—è¡¨
        var colors = ['#00C6FB', '#FF6B6B', '#00D9A5', '#FFD93D', '#A29BFE'];
        
        // æ¸©åº¦å¯¹æ¯”å›¾
        var tempChart = echarts.init(document.getElementById('tempCompareChart'));
        var tempSeries = compareData.map(function(item, idx) {
            return {
                name: item.name,
                type: 'line',
                smooth: true,
                data: item.temps,
                lineStyle: { width: 3 },
                itemStyle: { color: colors[idx % colors.length] }
            };
        });
        
        tempChart.setOption({
            tooltip: { trigger: 'axis' },
            legend: {
                data: compareData.map(function(item) { return item.name; }),
                textStyle: { color: '#fff' },
                bottom: 10
            },
            grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
            xAxis: {
                type: 'category',
                data: months.map(function(m) { return m + 'æœˆ'; }),
                axisLabel: { color: '#fff' },
                axisLine: { lineStyle: { color: '#00C6FB' } }
            },
            yAxis: {
                type: 'value',
                name: 'æ¸©åº¦(Â°C)',
                nameTextStyle: { color: '#fff' },
                axisLabel: { color: '#fff' },
                splitLine: { lineStyle: { color: 'rgba(0, 198, 251, 0.2)' } }
            },
            series: tempSeries
        });
        
        // é£é€Ÿå¯¹æ¯”å›¾
        var windChart = echarts.init(document.getElementById('windCompareChart'));
        var windSeries = compareData.map(function(item, idx) {
            return {
                name: item.name,
                type: 'bar',
                data: item.winds,
                itemStyle: { color: colors[idx % colors.length] }
            };
        });
        
        windChart.setOption({
            tooltip: { trigger: 'axis' },
            legend: {
                data: compareData.map(function(item) { return item.name; }),
                textStyle: { color: '#fff' },
                bottom: 10
            },
            grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true },
            xAxis: {
                type: 'category',
                data: months.map(function(m) { return m + 'æœˆ'; }),
                axisLabel: { color: '#fff' },
                axisLine: { lineStyle: { color: '#00C6FB' } }
            },
            yAxis: {
                type: 'value',
                name: 'é£é€Ÿ(m/s)',
                nameTextStyle: { color: '#fff' },
                axisLabel: { color: '#fff' },
                splitLine: { lineStyle: { color: 'rgba(0, 198, 251, 0.2)' } }
            },
            series: windSeries
        });
        
        // å“åº”å¼
        window.addEventListener('resize', function() {
            tempChart.resize();
            windChart.resize();
        });
    }
</script>
{% endblock %}
